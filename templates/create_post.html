<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시물 작성</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/create_post.css') }}">
</head>
<body>
    <div class="container">
        <!-- 헤더 -->
        <header>
            <button class="back-button" onclick="location.href='{{ url_for('main') }}'">←</button>
            <button class="close-button" onclick="location.href='{{ url_for('main') }}'">✕</button>
        </header>

        <!-- 게시물 작성 폼 -->
        <form action="{{ url_for('create_post') }}" method="POST" enctype="multipart/form-data">
            <div class="content-wrapper">
                <div class="search-section">
                    <!-- 제목 입력 -->
                    <div class="title-box">
                        <input type="text" id="title" placeholder="제목을 입력해주세요." name="title">
                    </div>
                    <!-- 음악 검색 -->
                    <div class="search-box">
                        <img src="{{ url_for('static', filename='img/search.png') }}" class="search-icon">
                        <input type="text" id="musicSearch" placeholder="노래 검색" name="music_query">
                    </div>

                    <div class="search-results" id="searchResults">
                        <input type="hidden" name="music_title" id="musicTitle">
                        <input type="hidden" name="music_artist" id="musicArtist">
                    </div>
                </div>

                <!-- 이미지 업로드 섹션 -->
                <div class="image-section">
                    <div class="image-upload-area" id="imageUploadArea">
                        <input type="file" id="imageInput" name="image" accept="image/*" style="display: none;">
                        <label for="imageInput" class="upload-label">
                            <div class="upload-placeholder">
                                <strong>+</strong>
                                <p>사진을 업로드하세요</p>
                            </div>
                        </label>
                        <img id="previewImage" class="preview-image" style="display: none;">
                    </div>
                </div>
            </div>

            <!-- 색상 팔레트 -->
            <div class="color-palette" id="colorPalette"></div>

            <div class="button-box">
                <button type="submit" class="submit-button">게시하기</button>
            </div>
        </form>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.2/color-thief.umd.js"></script>

    <script>
        const imageInput = document.getElementById('imageInput');
        const preview = document.getElementById('previewImage');
        const placeholder = document.querySelector('.upload-placeholder');
        const paletteContainer = document.getElementById('colorPalette');

        const searchInput = document.getElementById("musicSearch");
        const resultsBox = document.getElementById("searchResults");

        let paletteColors = []; // 추출한 색상 값을 저장하는 배열
        let selectedMusic = { title: "", artist: "" }; // 선택된 음악 정보 저장

        const form = document.querySelector('form');

        // RGB을 HEX로 변환
        function rgbToHex(r, g, b) {
            return "#" + [r, g, b].map(x => {
                const hex = x.toString(16);
                return hex.length === 1 ? "0" + hex : hex;
            }).join('');
        }

        // 이미지 업로드 + 미리보기 + 색상 추출
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();

            reader.onload = function(event) {
                // 이미지 미리보기 표시
                preview.src = event.target.result;
                preview.style.display = 'block';
                placeholder.style.display = 'none';

                const colorThief = new ColorThief();

                preview.onload = function() {
                    // 이미지에서 대표 색상 4개 추출
                    const palette = colorThief.getPalette(preview, 4);

                    // 변환하여 배열로 저장
                    paletteColors = palette.map(c => rgbToHex(c[0], c[1], c[2]));
                    paletteContainer.innerHTML = ''; // 기존 색상 박스 초기화

                    # 색상 박스 생성해 화면에 표시
                    paletteColors.forEach(color => {
                        const div = document.createElement('div');
                        div.className = 'color-box';
                        div.style.backgroundColor = color;
                        paletteContainer.appendChild(div);
                    });
                }
            }
            reader.readAsDataURL(file); // 업로드한 이미지 파일 읽기
        });

        // 음악 검색 + 선택
        let debounceTimer = null;

        searchInput.addEventListener("input", function() {
            const q = this.value.trim();
            clearTimeout(debounceTimer); // 이전 타이머 제거

            // 0.35초 동안 입력이 멈추면 검색 실행
            debounceTimer = setTimeout(() => {
                if (q.length < 1) {
                    resultsBox.innerHTML = "";
                    return;
                }

                // Flask의 /search_music API 호출
                fetch(`/search_music?q=${q}`)
                    .then(res => res.json())
                    .then(data => {
                        let html = "";

                        data.results.forEach(item => {
                            html += `
                            <div class="result-item">
                                <img src="${item.album_img}" class="album-cover">
                                <div class="result-info">
                                    <div class="song-title">${item.title}</div>
                                    <div class="artist-name">${item.artist}</div>
                                </div>
                            </div>`;
                        });
                        resultsBox.innerHTML = html;

                        document.querySelectorAll('.result-item').forEach(item => {
                            item.addEventListener('click', function() {
                                document.querySelectorAll('.result-item')
                                    .forEach(i => i.classList.remove('selected'));
                                this.classList.add('selected');

                                const title = this.querySelector(".song-title").innerText;
                                const artist = this.querySelector(".artist-name").innerText;

                                searchInput.value = title;
                                selectedMusic = { title, artist };
                            });
                        });
                    });
            }, 350);
        });

        // form submit 시 FormData로 변수 전송
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // 기본 submit 막기

            const formData = new FormData(form);

            // 색상 변수 추가
            paletteColors.forEach((color, i) => {
                formData.append(`color${i+1}`, color);
            });

            // 음악 변수 추가
            formData.append('music_title', selectedMusic.title);
            formData.append('music_artist', selectedMusic.artist);

            fetch(form.action, {
                method: 'POST',
                body: formData
            })
            .then(res => res.text())
            .then(() => {
                alert('게시물이 등록되었습니다!');
                window.location.href = '/main';
            })
            .catch(err => {
                console.error('게시물 등록 실패:', err);
                alert('게시물 등록에 실패했습니다.');
            });
        });
    </script>

</body>
</html>