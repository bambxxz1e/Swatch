<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Swatch</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
  </head>
  <body>
    <header>
        <div class="header-box">
            <img src="{{ url_for('static', filename='img/swatch_logo.png') }}" alt="로고 이미지">

            <!-- 플러스 버튼 -->
            <button class="plus-button" onclick="location.href='{{ url_for('create_post') }}'">
                <img src="{{ url_for('static', filename='img/plus.png') }}">
            </button>
        </div>
    </header>

    <main>
        <div class="posts-grid">
            {% for post in posts %}
            <div class="post-card" data-id="{{ post.record_id }}">

                <div class="post-top">
                    <div class="post-img-area">
                        <img src="{{ post.ootd_image_url }}">
                    </div>

                    {% if post.color_palette %}
                    <div class="color-palette-vertical">
                        {% for color in post.color_palette[:5] %}
                        <div class="color-swatch-vertical" style="background-color: {{ color }};"></div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <div class="post-info">
                    {% if post.title %}
                    <h3 class="post-title">{{ post.title }}</h3>
                    {% endif %}

                    <div class="post-date">{{ post.created_at.strftime('%Y.%m.%d') }}</div>

                    {% if post.song_title and post.artist %}
                    <div class="post-song">{{ post.artist }} - {{ post.song_title }}</div>
                    {% endif %}
                </div>

            </div>
            {% endfor %}
        </div>

        <!-- 삭제 확인 모달 -->
        <div id="deleteModal" class="modal" style="display:none;">
            <div class="modal-content">
                <p>삭제하시겠습니까?</p>
                <div class="button-box">
                    <button id="confirmDelete">삭제</button>
                    <button id="cancelDelete">취소</button>
                </div>
            </div>
        </div>
    </main>

    {% with messages = get_flashed_messages() %}
       {% if messages %}
          <script>
             alert("{{ messages[0] }}");
          </script>
        {% endif %}
    {% endwith %}

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const postsGrid = document.querySelector('.posts-grid');
            const modal = document.getElementById('deleteModal');
            const confirmBtn = document.getElementById('confirmDelete');
            const cancelBtn = document.getElementById('cancelDelete');

            let targetPostId = null;
            let targetCard = null;

            // posts-grid에서 클릭 발생하면 체크
            postsGrid.addEventListener('click', (e) => {
                const card = e.target.closest('.post-card'); // 클릭한 요소가 post-card 내부면 찾기
                if (!card) return; // 카드 외부 클릭 시 무시

                targetPostId = card.dataset.id;
                targetCard = card;
                modal.style.display = 'block';
            });

            // 취소 버튼
            cancelBtn.addEventListener('click', () => {
                modal.style.display = 'none';
                targetPostId = null;
                targetCard = null;
            });

            // 삭제 확인
            confirmBtn.addEventListener('click', () => {
                fetch(`/delete_post/${targetPostId}`, { method: 'POST' })
                    .then(res => res.json())
                    .then(data => {
                        if(data.success){
                            targetCard.remove(); // 화면에서도 제거
                        }
                        modal.style.display = 'none';
                    })
                    .catch(err => console.error(err));
            });
        });
    </script>

  </body>
</html>